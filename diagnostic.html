<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow: auto; }
        button { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #218838; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .test-result { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üîç Supabase Connection Diagnostic</h1>
    
    <div id="connection-status" class="status info">
        Testing connection...
    </div>

    <div class="test-result">
        <h3>üìã Quick Setup Checklist</h3>
        <ol>
            <li>‚úÖ Server running on port 3000</li>
            <li id="db-check">‚è≥ Database schema setup (checking...)</li>
            <li id="auth-check">‚è≥ Authentication test (checking...)</li>
        </ol>
    </div>

    <div class="test-result">
        <h3>üß™ Connection Tests</h3>
        <button onclick="testConnection()">Test Supabase Connection</button>
        <button onclick="testSignup()">Test Account Creation</button>
        <button onclick="checkTables()">Check Database Tables</button>
        <div id="test-results" style="margin-top: 15px;"></div>
    </div>

    <div class="test-result">
        <h3>üéØ Quick Account Creation</h3>
        <div style="margin-bottom: 10px;">
            <input type="email" id="test-email" placeholder="Enter email" style="padding: 8px; width: 250px;">
            <input type="password" id="test-password" placeholder="Enter password" style="padding: 8px; width: 150px;">
            <button onclick="quickSignup()">Create Test Account</button>
        </div>
        <div id="signup-result"></div>
    </div>

    <div class="test-result">
        <h3>üìä Server Status</h3>
        <pre id="server-status">Checking server status...</pre>
    </div>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>

    <script>
        let testResults = document.getElementById('test-results');
        let serverStatus = document.getElementById('server-status');
        let connectionStatus = document.getElementById('connection-status');

        // Auto-run diagnostics on page load
        window.addEventListener('load', function() {
            setTimeout(runAllDiagnostics, 1000);
        });

        async function runAllDiagnostics() {
            try {
                await testConnection();
                await checkTables();
                await checkServerStatus();
            } catch (error) {
                console.error('Diagnostic error:', error);
            }
        }

        async function testConnection() {
            try {
                if (!window.supabase || !window.supabase.getClient) {
                    throw new Error('Supabase client not loaded');
                }

                const client = window.supabase.getClient();
                
                // Test connection by trying to get session
                const { data, error } = await client.auth.getSession();
                
                if (error) {
                    throw error;
                }

                connectionStatus.className = 'status success';
                connectionStatus.innerHTML = '‚úÖ Supabase connection successful!';
                
                addTestResult('‚úÖ Connection Test', 'Supabase client connected successfully', 'success');
                
                return true;
            } catch (error) {
                connectionStatus.className = 'status error';
                connectionStatus.innerHTML = '‚ùå Supabase connection failed: ' + error.message;
                
                addTestResult('‚ùå Connection Test', 'Failed: ' + error.message, 'error');
                return false;
            }
        }

        async function testSignup() {
            const email = 'test@example.com';
            const password = 'testpassword123';
            
            try {
                const { data, error } = await window.supabase.auth.signUp(email, password, {
                    full_name: 'Test User'
                });
                
                if (error) {
                    if (error.message.includes('already registered')) {
                        addTestResult('‚ö†Ô∏è Signup Test', 'Email already exists (this is OK)', 'warning');
                    } else {
                        throw error;
                    }
                } else {
                    addTestResult('‚úÖ Signup Test', 'Account creation works', 'success');
                }
            } catch (error) {
                addTestResult('‚ùå Signup Test', 'Failed: ' + error.message, 'error');
            }
        }

        async function checkTables() {
            try {
                const client = window.supabase.getClient();
                
                // Try to query the wellness_data table
                const { data, error } = await client.from('wellness_data').select('*').limit(1);
                
                if (error) {
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        addTestResult('‚ùå Database Check', 'Tables not created yet. Run the SQL schema in Supabase!', 'error');
                        document.getElementById('db-check').innerHTML = '‚ùå Database schema missing - <strong>Run SQL script!</strong>';
                    } else {
                        throw error;
                    }
                } else {
                    addTestResult('‚úÖ Database Check', 'Tables exist and accessible', 'success');
                    document.getElementById('db-check').innerHTML = '‚úÖ Database schema setup complete';
                }
            } catch (error) {
                addTestResult('‚ùå Database Check', 'Error: ' + error.message, 'error');
            }
        }

        async function quickSignup() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const signupResult = document.getElementById('signup-result');
            
            if (!email || !password) {
                signupResult.innerHTML = '<div class="status error">Please enter email and password</div>';
                return;
            }
            
            try {
                const { data, error } = await window.supabase.auth.signUp(email, password, {
                    full_name: 'Test User'
                });
                
                if (error) {
                    if (error.message.includes('already registered')) {
                        signupResult.innerHTML = '<div class="status warning">‚ö†Ô∏è Account already exists. Try logging in instead.</div>';
                    } else {
                        throw error;
                    }
                } else {
                    signupResult.innerHTML = '<div class="status success">‚úÖ Account created successfully!</div>';
                    
                    // Try to login
                    setTimeout(async () => {
                        try {
                            const { data: loginData, error: loginError } = await window.supabase.auth.signIn(email, password);
                            if (!loginError) {
                                signupResult.innerHTML += '<div class="status success">‚úÖ Login test successful!</div>';
                            }
                        } catch (loginErr) {
                            console.error('Login test failed:', loginErr);
                        }
                    }, 2000);
                }
            } catch (error) {
                signupResult.innerHTML = '<div class="status error">‚ùå Failed: ' + error.message + '</div>';
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('/api/wellness/score');
                if (response.ok) {
                    serverStatus.textContent = '‚úÖ Server API endpoints responding correctly';
                } else if (response.status === 401) {
                    serverStatus.textContent = '‚úÖ Server running (401 expected without auth)';
                } else {
                    serverStatus.textContent = `‚ö†Ô∏è Server responded with status: ${response.status}`;
                }
            } catch (error) {
                serverStatus.textContent = '‚ùå Server connection failed: ' + error.message;
            }
        }

        function addTestResult(title, message, type) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            testResults.appendChild(resultDiv);
        }
    </script>
</body>
</html>